<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RINGING - ë¹™í•˜ê¸° ìƒì¡´ ì–´ë“œë²¤ì²˜</title>
  <style>
    :root {
      --bg-primary: #0a0a1a;
      --bg-secondary: #1a2744;
      --color-danger: #ef4444;
      --color-sanity: #a855f7;
      --color-cold: #38bdf8;
      --color-warm: #fbbf24;
      --color-text: #f3f4f6;
      --color-text-dim: #9ca3af;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      padding: 10px; overflow: hidden;
    }

    /* Snow Effect */
    .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden; }
    .snowflake { position: absolute; top: -10px; color: rgba(255,255,255,0.8); font-size: 10px; animation: fall linear infinite; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    @keyframes fall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; } }

    /* Phone Frame */
    .phone-frame { width: 320px; height: 600px; border-radius: 24px; overflow: hidden; position: relative; border: 2px solid #2d3748; box-shadow: 0 25px 50px rgba(0,0,0,0.7), 0 0 60px rgba(56,189,248,0.1); background: var(--bg-primary); }
    .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
    .screen.active { display: flex; }

    /* Loading Screen */
    #loadingScreen { background: var(--bg-primary); align-items: center; justify-content: center; text-align: center; }
    .loading-spinner { width: 50px; height: 50px; border: 3px solid #374151; border-top-color: var(--color-cold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--color-text-dim); font-size: 14px; }
    .loading-status { color: var(--color-cold); font-size: 12px; margin-top: 10px; }

    /* Title Screen */
    #titleScreen { background: linear-gradient(180deg, #0a0a1a 0%, #1a2744 50%, #0f1729 100%); align-items: center; justify-content: center; text-align: center; }
    .title-content { z-index: 10; }
    .game-logo { font-size: 48px; font-weight: bold; color: var(--color-text); text-shadow: 0 0 30px rgba(56,189,248,0.5), 0 4px 20px rgba(0,0,0,0.5); letter-spacing: 8px; margin-bottom: 8px; animation: logoGlow 3s ease-in-out infinite; }
    @keyframes logoGlow { 0%, 100% { text-shadow: 0 0 30px rgba(56,189,248,0.5), 0 4px 20px rgba(0,0,0,0.5); } 50% { text-shadow: 0 0 50px rgba(56,189,248,0.8), 0 4px 20px rgba(0,0,0,0.5); } }
    .game-subtitle { font-size: 12px; color: var(--color-cold); letter-spacing: 4px; margin-bottom: 60px; opacity: 0.8; }
    .title-btn { display: block; width: 200px; padding: 14px 24px; margin: 10px auto; background: linear-gradient(135deg, rgba(56,189,248,0.2), rgba(168,85,247,0.2)); border: 1px solid rgba(56,189,248,0.3); border-radius: 12px; color: var(--color-text); font-size: 14px; cursor: pointer; transition: all 0.3s; }
    .title-btn:hover { background: linear-gradient(135deg, rgba(56,189,248,0.3), rgba(168,85,247,0.3)); border-color: var(--color-cold); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(56,189,248,0.2); }
    .title-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .title-footer { position: absolute; bottom: 20px; font-size: 10px; color: var(--color-text-dim); opacity: 0.5; }

    /* Companion Screen */
    #companionScreen { background: linear-gradient(180deg, #0a0a1a 0%, #1a2744 100%); padding: 20px; }
    .companion-header { text-align: center; margin-bottom: 20px; }
    .companion-title { font-size: 18px; color: var(--color-text); margin-bottom: 6px; }
    .companion-desc { font-size: 11px; color: var(--color-text-dim); }
    .companion-list { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
    .companion-card { background: rgba(31,41,55,0.8); border: 2px solid #374151; border-radius: 12px; padding: 14px; cursor: pointer; transition: all 0.3s; position: relative; }
    .companion-card:hover:not(.locked) { border-color: var(--color-warm); transform: translateX(4px); }
    .companion-card.selected { border-color: var(--color-warm); background: rgba(251,191,36,0.1); }
    .companion-card.locked { opacity: 0.5; cursor: not-allowed; }
    .companion-info { display: flex; align-items: center; gap: 12px; }
    .companion-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #374151, #1f2937); display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
    .companion-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .companion-details { flex: 1; }
    .companion-name { font-size: 14px; color: var(--color-text); font-weight: bold; margin-bottom: 2px; }
    .companion-trait { font-size: 11px; color: var(--color-cold); }
    .companion-ability { font-size: 10px; color: var(--color-text-dim); margin-top: 6px; line-height: 1.4; }
    .lock-badge { position: absolute; top: 10px; right: 10px; font-size: 16px; }
    .unlock-hint { font-size: 9px; color: var(--color-danger); margin-top: 6px; }
    .start-btn { margin-top: 16px; padding: 14px; background: linear-gradient(135deg, var(--color-warm), #f59e0b); border: none; border-radius: 12px; color: #1a1a2e; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .start-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(251,191,36,0.3); }
    .start-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Game Screen */
    #gameScreen { background: var(--bg-primary); }
    .scene-bg { position: absolute; inset: 0; transition: background 0.8s, background-image 0.8s; background-size: cover; background-position: center; }
    .scene-bg-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%); }
    .vignette { position: absolute; inset: 0; pointer-events: none; box-shadow: inset 0 0 80px rgba(239,68,68,0.5); animation: pulse 3s ease-in-out infinite; opacity: 0; transition: opacity 0.3s; }
    .vignette.active { opacity: 1; }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.9; } }
    .listen-overlay { position: absolute; inset: 0; background: radial-gradient(circle at center 30%, transparent 10%, rgba(0,0,0,0.95) 100%); pointer-events: none; opacity: 0; transition: opacity 0.3s; }
    .listen-overlay.active { opacity: 1; }

    /* Top Bar */
    .top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 12px; display: flex; justify-content: space-between; align-items: center; z-index: 20; }
    .stats { display: flex; gap: 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); padding: 8px 12px; border-radius: 12px; }
    .stat { display: flex; align-items: center; gap: 6px; }
    .stat-icon { font-size: 16px; }
    .stat-bar { width: 50px; height: 8px; background: #374151; border-radius: 4px; overflow: hidden; }
    .stat-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
    .stat-value { font-size: 10px; color: var(--color-text-dim); min-width: 24px; }
    .top-buttons { display: flex; gap: 6px; }
    .top-btn { width: 36px; height: 36px; background: rgba(0,0,0,0.6); border: none; border-radius: 10px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .top-btn:hover { background: rgba(0,0,0,0.8); }

    /* Scene Info */
    .scene-info { position: absolute; top: 60px; left: 0; right: 0; text-align: center; z-index: 10; }
    .location-text { font-size: 11px; color: var(--color-text-dim); margin-bottom: 4px; }
    .scene-icon { font-size: 48px; opacity: 0.3; }

    /* Sound Area - Waveform UI */
    .sound-area { position: absolute; top: 140px; left: 12px; right: 12px; z-index: 20; cursor: pointer; user-select: none; }
    .sound-box { background: rgba(17,24,39,0.95); border-radius: 12px; padding: 12px 14px; border: 2px solid rgba(56,189,248,0.3); transition: all 0.3s; }
    .sound-box.mismatch { border-color: rgba(239,68,68,0.5); animation: soundPulse 2.5s infinite; }
    .sound-box.listening { border-color: var(--color-cold); background: rgba(17,24,39,0.98); }
    .sound-box.no-sound { opacity: 0.5; pointer-events: none; }
    @keyframes soundPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } 50% { box-shadow: 0 0 30px 5px rgba(239,68,68,0.4); } }
    .sound-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .sound-label { font-size: 11px; color: var(--color-cold); font-weight: bold; }
    .sound-hint { font-size: 10px; color: var(--color-danger); animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Waveform */
    .waveform-container { display: flex; align-items: center; justify-content: center; height: 30px; gap: 2px; margin: 8px 0; }
    .waveform-bar { width: 3px; background: var(--color-cold); border-radius: 2px; transition: height 0.1s; }
    .waveform-bar.static { height: 4px; opacity: 0.5; }
    .sound-box.listening .waveform-bar { animation: waveAnim 0.5s ease-in-out infinite; }
    @keyframes waveAnim { 0%, 100% { height: 4px; } 50% { height: 100%; } }

    .sound-text { font-size: 13px; color: #a5f3fc; line-height: 1.6; text-align: center; min-height: 20px; }
    .sound-detail { display: none; font-size: 12px; color: var(--color-warm); margin-top: 8px; text-align: center; font-style: italic; }
    .sound-box.listening .sound-detail { display: block; }

    /* Main Text Area */
    .main-text-area { position: absolute; top: 280px; left: 12px; right: 12px; z-index: 20; }
    .main-box { background: rgba(0,0,0,0.85); border-radius: 12px; padding: 14px; backdrop-filter: blur(4px); }
    .speaker { font-size: 12px; color: var(--color-warm); margin-bottom: 8px; font-weight: bold; }
    .main-text { font-size: 14px; color: var(--color-text); line-height: 1.7; white-space: pre-line; }

    /* Choice Area */
    .choice-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; z-index: 20; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); }
    .choice-buttons { display: flex; flex-direction: column; gap: 8px; }
    .choice-btn { width: 100%; padding: 14px 16px; background: rgba(55,65,81,0.9); border: 2px solid #4b5563; border-radius: 12px; color: var(--color-text); font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: left; }
    .choice-btn:hover { border-color: var(--color-warm); background: rgba(75,85,99,0.9); transform: translateX(4px); }
    .choice-btn:active { transform: scale(0.98); }

    /* Modals */
    .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; padding: 16px; }
    .modal.active { display: flex; }
    .modal-content { background: #1f2937; border-radius: 16px; padding: 20px; width: 100%; max-width: 280px; max-height: 90%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 16px; color: var(--color-text); font-weight: bold; }
    .modal-close { background: none; border: none; color: var(--color-text-dim); font-size: 20px; cursor: pointer; }
    .modal-close:hover { color: var(--color-text); }
    .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .inv-item { aspect-ratio: 1; background: #374151; border: 1px solid #4b5563; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .inv-item:hover { border-color: var(--color-warm); background: #4b5563; transform: scale(1.05); }
    .inv-item.empty { opacity: 0.3; cursor: default; }
    .inv-icon { font-size: 26px; }
    .inv-name { font-size: 10px; color: #d1d5db; margin-top: 4px; }
    .help-text { font-size: 13px; color: #d1d5db; line-height: 2; }
    .help-warning { margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; }
    .help-warning p { font-size: 11px; color: #fca5a5; line-height: 1.6; }
    .close-btn { width: 100%; margin-top: 16px; padding: 12px; background: #374151; border: none; border-radius: 10px; color: var(--color-text); cursor: pointer; font-size: 13px; }
    .close-btn:hover { background: #4b5563; }

    /* Notification */
    .notification { position: absolute; top: 60px; left: 12px; right: 12px; background: rgba(0,0,0,0.95); border-radius: 12px; padding: 12px; text-align: center; font-size: 13px; color: var(--color-text); z-index: 60; display: none; animation: slideIn 0.3s; border: 1px solid #374151; }
    .notification.active { display: block; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    /* Game Over */
    .gameover-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 70; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .gameover-overlay.active { display: flex; }
    .gameover-text { font-size: 32px; color: var(--color-danger); font-weight: bold; margin-bottom: 16px; }
    .gameover-reason { font-size: 14px; color: var(--color-text-dim); margin-bottom: 30px; }
  </style>
</head>
<body>
  <div class="snow-container" id="snowContainer"></div>
  <div class="phone-frame" id="phone">

    <!-- Loading Screen -->
    <div class="screen active" id="loadingScreen">
      <div class="loading-spinner"></div>
      <div class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      <div class="loading-status" id="loadingStatus"></div>
    </div>

    <!-- Title Screen -->
    <div class="screen" id="titleScreen">
      <div class="title-content">
        <div class="game-logo" id="gameTitle">RINGING</div>
        <div class="game-subtitle" id="gameSubtitle">ë¹™í•˜ê¸° ìƒì¡´ ì–´ë“œë²¤ì²˜</div>
        <button class="title-btn" onclick="showScreen('companionScreen')">ìƒˆ ê²Œì„</button>
        <button class="title-btn" style="opacity:0.5" disabled>ì´ì–´í•˜ê¸°</button>
      </div>
      <div class="title-footer">2040ë…„, ëŒ€í•œë¯¼êµ­</div>
    </div>

    <!-- Companion Screen -->
    <div class="screen" id="companionScreen">
      <div class="companion-header">
        <div class="companion-title">ë™ë£Œ ì„ íƒ</div>
        <div class="companion-desc">í•¨ê»˜í•  ë™ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      <div class="companion-list" id="companionList"></div>
      <button class="start-btn" id="startBtn" onclick="startGame()" disabled>ë™ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”</button>
    </div>

    <!-- Game Screen -->
    <div class="screen" id="gameScreen">
      <div class="scene-bg" id="sceneBg"></div>
      <div class="scene-bg-overlay"></div>
      <div class="vignette" id="vignette"></div>
      <div class="listen-overlay" id="listenOverlay"></div>
      <div class="notification" id="notification"></div>

      <div class="top-bar">
        <div class="stats">
          <div class="stat"><span class="stat-icon">â¤ï¸</span><div class="stat-bar"><div class="stat-fill" id="healthBar" style="width:100%; background:var(--color-danger);"></div></div><span class="stat-value" id="healthVal">100</span></div>
          <div class="stat"><span class="stat-icon">ğŸ§ </span><div class="stat-bar"><div class="stat-fill" id="sanityBar" style="width:100%; background:var(--color-sanity);"></div></div><span class="stat-value" id="sanityVal">100</span></div>
        </div>
        <div class="top-buttons">
          <button class="top-btn" onclick="toggleHelp()">â“</button>
          <button class="top-btn" onclick="toggleBag()">ğŸ’</button>
        </div>
      </div>

      <div class="scene-info">
        <div class="location-text" id="locationText"></div>
        <div class="scene-icon" id="sceneIcon"></div>
      </div>

      <div class="sound-area" id="soundArea" onmousedown="startListen()" onmouseup="endListen()" onmouseleave="endListen()" ontouchstart="startListen()" ontouchend="endListen()">
        <div class="sound-box" id="soundBox">
          <div class="sound-header">
            <span class="sound-label">ğŸ‘‚ ì²­ê° ì •ë³´</span>
            <span class="sound-hint" id="soundHint">ê¾¹ ëˆŒëŸ¬ì„œ ì§‘ì¤‘</span>
          </div>
          <div class="waveform-container" id="waveform"></div>
          <div class="sound-text" id="soundText">ë¬´ì–¸ê°€ ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤...</div>
          <div class="sound-detail" id="soundDetail"></div>
        </div>
      </div>

      <div class="main-text-area">
        <div class="main-box">
          <div class="speaker" id="speaker"></div>
          <div class="main-text" id="mainText"></div>
        </div>
      </div>

      <div class="choice-area">
        <div class="choice-buttons" id="choiceButtons"></div>
      </div>

      <!-- Help Modal -->
      <div class="modal" id="helpModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title">ğŸ® ì¡°ì‘ë²•</span>
            <button class="modal-close" onclick="toggleHelp()">âœ•</button>
          </div>
          <div class="help-text">
            ğŸ“± ì„ íƒì§€ë¥¼ í„°ì¹˜í•˜ì—¬ í–‰ë™ ì„ íƒ<br>
            ğŸ‘‚ ì²­ê° ì˜ì—­ ê¾¹ ëˆ„ë¥´ë©´ ì§‘ì¤‘<br>
            ğŸ’ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œ ì‚¬ìš©
          </div>
          <div class="help-warning">
            <p>âš ï¸ ë¶‰ì€ í…Œë‘ë¦¬ = ë¶ˆì¼ì¹˜ ìƒí™©<br>ì²­ê°ì— ì§‘ì¤‘í•˜ì—¬ ìˆ¨ê²¨ì§„ ì •ë³´ë¥¼ íŒŒì•…í•˜ì„¸ìš”.</p>
          </div>
          <button class="close-btn" onclick="toggleHelp()">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- Inventory Modal -->
      <div class="modal" id="bagModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title">ğŸ’ ì¸ë²¤í† ë¦¬</span>
            <button class="modal-close" onclick="toggleBag()">âœ•</button>
          </div>
          <div class="inventory-grid" id="inventoryGrid"></div>
        </div>
      </div>

      <!-- Game Over -->
      <div class="gameover-overlay" id="gameoverOverlay">
        <div class="gameover-text">GAME OVER</div>
        <div class="gameover-reason" id="gameoverReason"></div>
        <button class="title-btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <!-- Audio Element for Sound Playback -->
  <audio id="soundPlayer" preload="auto"></audio>

  <script>
    // =====================================================
    // ===== BACKEND CONFIG (ì—¬ê¸°ì„œë§Œ ì„¤ì •) =====
    // =====================================================
    const CONFIG = {
      API_KEY: 'AIzaSyDCyFtJIAONm_LtZxAyKYhYes-2FZ8K1AU',
      SPREADSHEET_ID: '16LtN9qtgWG7Fhc2TRKUgWA_6IIpiYcslnEaRmVUDRww',
      CACHE_KEY: 'ringing_game_data',
      CACHE_DURATION: 1000 * 60 * 30,
      ANALYTICS_URL: 'https://script.google.com/macros/s/AKfycbz0ltWlEWlZSUAQ8_0tzQAQ0Z7JcP6mROkVeJ-p7avQD_UQpA3P-V6y___cu7i1maBd/exec'
    };
    // =====================================================

    // ===== ANALYTICS =====
    const sessionId = generateSessionId();
    let gameStartTime = null;
    let listenStartTime = null;

    function generateSessionId() {
      return Math.random().toString(36).substring(2, 10);
    }

    function getPlayTime() {
      if (!gameStartTime) return 0;
      return Math.floor((Date.now() - gameStartTime) / 1000);
    }

    async function sendAnalytics(eventType, detail = {}) {
      if (!CONFIG.ANALYTICS_URL) return;
      try {
        const payload = {
          session_id: sessionId,
          event_type: eventType,
          scene_id: currentSceneId || '',
          detail: detail,
          health: stats.health,
          sanity: stats.sanity,
          play_time: getPlayTime(),
          companion: selectedCompanion ? selectedCompanion.name : ''
        };
        fetch(CONFIG.ANALYTICS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        console.log('[Analytics]', eventType, detail);
      } catch (e) {
        console.error('[Analytics Error]', e);
      }
    }

    // ===== GAME STATE =====
    let gameData = { scenes: [], choices: [], characters: [], encounters: [], items: [], config: {} };
    let currentSceneId = 'scene_00';
    let selectedCompanion = null;
    let stats = { health: 100, sanity: 100 };
    let inventory = [];
    let isListening = false;
    let listenTimer = null;

    // ===== DATA LOADER =====
    async function loadGameData() {
      updateLoadingStatus('ë°ì´í„° ì†ŒìŠ¤ í™•ì¸ ì¤‘...');
      const cached = getCachedData();
      if (cached) { updateLoadingStatus('ìºì‹œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'); gameData = cached; initGame(); return; }
      if (CONFIG.API_KEY && CONFIG.SPREADSHEET_ID) {
        try { updateLoadingStatus('Google Sheets ì—°ê²° ì¤‘...'); await loadFromGoogleSheets(); cacheData(gameData); initGame(); return; }
        catch (e) { console.error('Google Sheets ë¡œë“œ ì‹¤íŒ¨:', e); updateLoadingStatus('ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©'); }
      }
      updateLoadingStatus('ê¸°ë³¸ ë°ì´í„° ë¡œë“œ ì¤‘...'); loadDefaultData(); initGame();
    }

    async function loadFromGoogleSheets() {
      const sheets = ['Scenes', 'Choices', 'Characters', 'Encounters', 'Items', 'Config'];
      for (const sheet of sheets) {
        updateLoadingStatus(`${sheet} ì‹œíŠ¸ ë¡œë“œ ì¤‘...`);
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${sheet}?key=${CONFIG.API_KEY}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load ${sheet}`);
        const data = await response.json();
        parseSheetData(sheet, data.values);
      }
    }

    function parseSheetData(sheetName, rows) {
      if (!rows || rows.length < 2) return;
      const headers = rows[0];
      const data = rows.slice(1).map(row => { const obj = {}; headers.forEach((h, i) => { obj[h] = row[i] || ''; }); return obj; });
      switch (sheetName) {
        case 'Scenes': gameData.scenes = data; break;
        case 'Choices': gameData.choices = data; break;
        case 'Characters': gameData.characters = data; break;
        case 'Encounters': gameData.encounters = data; break;
        case 'Items': gameData.items = data; break;
        case 'Config': data.forEach(row => { gameData.config[row.key] = row.value; }); break;
      }
    }

    function loadDefaultData() {
      gameData.scenes = [
        {scene_id:'scene_00',location:'ì„œìš¸, ìíƒ',icon:'ğŸ ',background_type:'gradient',background_url:'',main_text:'2040ë…„ ê²¨ìš¸.\\nê°‘ì‘ìŠ¤ëŸ¬ìš´ í•œíŒŒê°€ ëŒ€í•œë¯¼êµ­ì„ ë®ì³¤ë‹¤.\\n\\në¼ë””ì˜¤ì—ì„œëŠ” ë¶€ì‚°ìœ¼ë¡œ ëŒ€í”¼í•˜ë¼ëŠ” ë°©ì†¡ì´ í˜ëŸ¬ë‚˜ì˜¨ë‹¤.',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'TRUE',sound_hint:'ì°½ë°–ìœ¼ë¡œ ë§¤ì„œìš´ ë°”ëŒ ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤',sound_detail:'...ë©€ë¦¬ì„œ ì‚¬ì´ë Œ ì†Œë¦¬. ëŒ€í”¼ ë°©ì†¡ì´ ìš¸ë¦°ë‹¤.',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_01',location:'ì„œìš¸, ê±°ë¦¬',icon:'ğŸ™ï¸',background_type:'gradient',background_url:'',main_text:'ê±°ë¦¬ëŠ” í…… ë¹„ì–´ìˆë‹¤.\\nëˆˆë³´ë¼ ì†ì—ì„œ ë™ë£Œì™€ í•¨ê»˜ ë‚¨ìª½ì„ í–¥í•´ ê±·ëŠ”ë‹¤.\\n\\n"ì¼ë‹¨ íœ´ê²Œì†Œë¥¼ ì°¾ì•„ë³´ì."',speaker:'',has_sound:'TRUE',sound_hint:'ëˆˆ ë°ŸëŠ” ë°œìêµ­ ì†Œë¦¬',sound_detail:'ë™ë£Œì˜ ë°œìêµ­... ê·¸ë¦¬ê³  ì € ë©€ë¦¬ì„œ ë‹¤ë¥¸ ë°œìêµ­ ì†Œë¦¬.',sound_url:'',has_mismatch:'FALSE'},
        {scene_id:'scene_02',location:'ê²½ê¸°ë„, íœ´ê²Œì†Œ',icon:'â›½',background_type:'gradient',background_url:'',main_text:'"ì—¬ê¸°ì„œ ì ì‹œ ì‰¬ì–´ê°€ì.\\nì²´ë ¥ì„ íšŒë³µí•´ì•¼ í•´."',speaker:'ë™ë£Œ',has_sound:'TRUE',sound_hint:'ëª¨ë‹¥ë¶ˆ íƒ€ëŠ” ì†Œë¦¬',sound_detail:'ë¶ˆê½ƒ ì†Œë¦¬ ì‚¬ì´ë¡œ... ëˆ„êµ°ê°€ì˜ ì†ì‚­ì„ì´ ë“¤ë¦°ë‹¤.',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_03',location:'ê³ ì†ë„ë¡œ',icon:'ğŸ›£ï¸',background_type:'gradient',background_url:'',main_text:'íì°¨ë“¤ ì‚¬ì´ë¡œ ê¸¸ì„ ê±·ëŠ”ë‹¤.\\nê°‘ìê¸° ë™ë£Œê°€ ë©ˆì¶° ì„°ë‹¤.\\n\\n"ì €ê¸°... ë­”ê°€ ìˆì–´."',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'TRUE',sound_hint:'ë°”ëŒì´ ìš¸ë¶€ì§–ëŠ” ì†Œë¦¬',sound_detail:'ë°”ëŒ ì†Œë¦¬... ì•„ë‹ˆ, ì´ê±´ ì°¨ëŸ‰ ì†Œë¦¬ë‹¤. ëˆ„êµ°ê°€ ì˜¨ë‹¤.',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_04',location:'ëŒ€ì „ ì™¸ê³½',icon:'ğŸšï¸',background_type:'gradient',background_url:'',main_text:'ë²„ë ¤ì§„ ê±´ë¬¼ ì•ì—ì„œ í•œ ì‚¬ëŒì„ ë§Œë‚¬ë‹¤.\\n\\n"ë‹¹ì‹ ë“¤ë„ ë¶€ì‚°ìœ¼ë¡œ ê°€ëŠ” ê±´ê°€?\\nê°™ì´ ê°€ì§€ ì•Šê² ì–´?"',speaker:'???',has_sound:'TRUE',sound_hint:'ì ë§‰í•œ ì •ì ',sound_detail:'...ìˆ¨ì†Œë¦¬. ê±´ë¬¼ ì•ˆì— ëˆ„êµ°ê°€ ìˆë‹¤.',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_05',location:'í”¼ë‚œì²˜',icon:'ğŸ•ï¸',background_type:'gradient',background_url:'',main_text:'ì„ì‹œ í”¼ë‚œì²˜ì— ë„ì°©í–ˆë‹¤.\\nì—¬ëŸ¬ ìƒì¡´ìë“¤ì´ ëª¨ì—¬ìˆë‹¤.\\n\\në²½ì— ë¶™ì€ ì „ë‹¨ì§€ê°€ ëˆˆì— ë“¤ì–´ì˜¨ë‹¤.',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'TRUE',sound_hint:'ì‚¬ëŒë“¤ì˜ ì›…ì„±ê±°ë¦¼',sound_detail:'"...ì •ë¶€ê°€ ìˆ¨ê¸°ê³  ìˆì–´." "ë¹™í•˜ê¸°ê°€ ì¸ê³µì ì´ë¼ê³ ?"',sound_url:'',has_mismatch:'FALSE'},
        {scene_id:'scene_06',location:'ê²½ë‚¨ ì§„ì…ë¡œ',icon:'ğŸŒ¨ï¸',background_type:'gradient',background_url:'',main_text:'ë™ë£Œì˜ í‘œì •ì´ ì‹¬ìƒì¹˜ ì•Šë‹¤.\\n\\n"...ì ê¹, í•  ì–˜ê¸°ê°€ ìˆì–´."',speaker:'ë™ë£Œ',has_sound:'TRUE',sound_hint:'ë™ë£Œì˜ ë°œê±¸ìŒì´ ëŠë ¤ì§„ë‹¤',sound_detail:'ë™ë£Œê°€ ë¬´ì „ê¸°ë¡œ ëˆ„êµ°ê°€ì™€ ì–˜ê¸°í•˜ê³  ìˆë‹¤...?',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_07',location:'ë¶€ì‚° ì™¸ê³½',icon:'ğŸŒŠ',background_type:'gradient',background_url:'',main_text:'ë“œë””ì–´ ë¶€ì‚°ì´ ë³´ì¸ë‹¤.\\ní•˜ì§€ë§Œ ì…êµ¬ì—ëŠ” ë¬´ì¥í•œ ì‚¬ëŒë“¤ì´ ìˆë‹¤.\\n\\n"ì—¬ê¸°ì„œë¶€í„°ëŠ” í†µì œ êµ¬ì—­ì´ë‹¤."',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'TRUE',sound_hint:'ë¨¼ íŒŒë„ ì†Œë¦¬',sound_detail:'íŒŒë„ ì†Œë¦¬... ê·¸ë¦¬ê³  í—¬ê¸° í”„ë¡œí ëŸ¬ ì†Œë¦¬. êµ°ëŒ€?',sound_url:'',has_mismatch:'FALSE'},
        {scene_id:'scene_08',location:'ë¶€ì‚°, ì•ˆì‹ì²˜',icon:'ğŸ›ï¸',background_type:'gradient',background_url:'',main_text:'ì•ˆì‹ì²˜ì— ë„ì°©í–ˆë‹¤.\\ní•˜ì§€ë§Œ ì´ê³³ì—ì„œ ì¶©ê²©ì ì¸ ì§„ì‹¤ì„ ì•Œê²Œ ëœë‹¤.\\n\\në¹™í•˜ê¸°ëŠ” ìì—°ì¬í•´ê°€ ì•„ë‹ˆì—ˆë‹¤.',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'TRUE',sound_hint:'ì‹¤ë‚´ì˜ ë”°ëœ»í•œ ê³µê¸°',sound_detail:'"...ì‹¤í—˜ì´ ì‹¤íŒ¨í–ˆì–´." "ì¸ë¥˜ì˜ ë¯¸ë˜ë¥¼ ìœ„í•´..."',sound_url:'',has_mismatch:'TRUE'},
        {scene_id:'scene_09',location:'ì—”ë”©',icon:'â„ï¸',background_type:'gradient',background_url:'',main_text:'ê¸°ë‚˜ê¸´ ì—¬ì •ì´ ëë‚¬ë‹¤.\\n\\në‹¹ì‹ ì€ ì‚´ì•„ë‚¨ì•˜ë‹¤.\\ní•˜ì§€ë§Œ ì´ê²ƒì´ ëì¼ê¹Œ, ì‹œì‘ì¼ê¹Œ?',speaker:'ë‚˜ë ˆì´ì…˜',has_sound:'FALSE',sound_hint:'',sound_detail:'ìƒˆë¡œìš´ ì‹œì‘ì˜ ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤.',sound_url:'',has_mismatch:'FALSE'}
      ];
      gameData.choices = [
        {choice_id:'c00_1',scene_id:'scene_00',order:'1',text:'ì§ì„ ì‹¸ê³  ì¶œë°œí•œë‹¤',next_scene_id:'scene_01',health_change:'0',sanity_change:'0'},
        {choice_id:'c00_2',scene_id:'scene_00',order:'2',text:'ì¢€ ë” ìƒí™©ì„ ì§€ì¼œë³¸ë‹¤',next_scene_id:'scene_01',health_change:'0',sanity_change:'-10'},
        {choice_id:'c01_1',scene_id:'scene_01',order:'1',text:'ë™ë£Œì˜ ë§ì„ ë”°ë¥¸ë‹¤',next_scene_id:'scene_02',health_change:'0',sanity_change:'5'},
        {choice_id:'c01_2',scene_id:'scene_01',order:'2',text:'ë‹¤ë¥¸ ê¸¸ì„ ì œì•ˆí•œë‹¤',next_scene_id:'scene_02',health_change:'0',sanity_change:'0'},
        {choice_id:'c02_1',scene_id:'scene_02',order:'1',text:'íœ´ì‹ì„ ì·¨í•œë‹¤',next_scene_id:'scene_03',health_change:'15',sanity_change:'0'},
        {choice_id:'c02_2',scene_id:'scene_02',order:'2',text:'ì£¼ë³€ì„ íƒìƒ‰í•œë‹¤',next_scene_id:'scene_03',health_change:'0',sanity_change:'0'},
        {choice_id:'c02_3',scene_id:'scene_02',order:'3',text:'ë°”ë¡œ ì¶œë°œí•œë‹¤',next_scene_id:'scene_03',health_change:'-10',sanity_change:'0'},
        {choice_id:'c03_1',scene_id:'scene_03',order:'1',text:'ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë‹¤ê°€ê°„ë‹¤',next_scene_id:'scene_04',health_change:'0',sanity_change:'0'},
        {choice_id:'c03_2',scene_id:'scene_03',order:'2',text:'ìˆ¨ì–´ì„œ ê´€ì°°í•œë‹¤',next_scene_id:'scene_04',health_change:'0',sanity_change:'5'},
        {choice_id:'c03_3',scene_id:'scene_03',order:'3',text:'ë‹¤ë¥¸ ê¸¸ë¡œ ìš°íšŒí•œë‹¤',next_scene_id:'scene_04',health_change:'-5',sanity_change:'0'},
        {choice_id:'c04_1',scene_id:'scene_04',order:'1',text:'í•¨ê»˜ ê°€ìê³  í•œë‹¤',next_scene_id:'scene_05',health_change:'0',sanity_change:'10'},
        {choice_id:'c04_2',scene_id:'scene_04',order:'2',text:'ê²½ê³„í•˜ë©° ê±°ì ˆí•œë‹¤',next_scene_id:'scene_05',health_change:'0',sanity_change:'0'},
        {choice_id:'c05_1',scene_id:'scene_05',order:'1',text:'ì „ë‹¨ì§€ë¥¼ ì½ì–´ë³¸ë‹¤',next_scene_id:'scene_06',health_change:'0',sanity_change:'0'},
        {choice_id:'c05_2',scene_id:'scene_05',order:'2',text:'ì‚¬ëŒë“¤ê³¼ ëŒ€í™”í•œë‹¤',next_scene_id:'scene_06',health_change:'0',sanity_change:'5'},
        {choice_id:'c05_3',scene_id:'scene_05',order:'3',text:'ì¡°ìš©íˆ ì‰°ë‹¤',next_scene_id:'scene_06',health_change:'10',sanity_change:'0'},
        {choice_id:'c06_1',scene_id:'scene_06',order:'1',text:'ë¬´ìŠ¨ ì¼ì´ëƒê³  ë¬»ëŠ”ë‹¤',next_scene_id:'scene_07',health_change:'0',sanity_change:'0'},
        {choice_id:'c06_2',scene_id:'scene_06',order:'2',text:'ê²½ê³„í•˜ë©° ê±°ë¦¬ë¥¼ ë‘”ë‹¤',next_scene_id:'scene_07',health_change:'0',sanity_change:'-5'},
        {choice_id:'c07_1',scene_id:'scene_07',order:'1',text:'ì‚¬ì •ì„ ì„¤ëª…í•œë‹¤',next_scene_id:'scene_08',health_change:'0',sanity_change:'0'},
        {choice_id:'c07_2',scene_id:'scene_07',order:'2',text:'ë‹¤ë¥¸ ì…êµ¬ë¥¼ ì°¾ëŠ”ë‹¤',next_scene_id:'scene_08',health_change:'-10',sanity_change:'0'},
        {choice_id:'c07_3',scene_id:'scene_07',order:'3',text:'ë™ë£Œì˜ ë„ì›€ì„ ìš”ì²­í•œë‹¤',next_scene_id:'scene_08',health_change:'0',sanity_change:'0'},
        {choice_id:'c08_1',scene_id:'scene_08',order:'1',text:'ì§„ì‹¤ì„ íŒŒí—¤ì¹œë‹¤',next_scene_id:'scene_09',health_change:'0',sanity_change:'-15'},
        {choice_id:'c08_2',scene_id:'scene_08',order:'2',text:'ëª¨ë¥¸ ì²™ í•œë‹¤',next_scene_id:'scene_09',health_change:'0',sanity_change:'0'},
        {choice_id:'c09_1',scene_id:'scene_09',order:'1',text:'[ì—”ë”© A] ìƒˆë¡œìš´ ì‹œì‘',next_scene_id:'ending',health_change:'0',sanity_change:'0'},
        {choice_id:'c09_2',scene_id:'scene_09',order:'2',text:'[ì—”ë”© B] ì§„ì‹¤ì„ ì•Œë¦°ë‹¤',next_scene_id:'ending',health_change:'0',sanity_change:'0'}
      ];
      gameData.characters = [
        {char_id:'char_01',name:'ì–‘í¬ì„±',role:'companion',personality:'ìš°ì§í•¨ / í”ë“¤ë¦¼ ì—†ëŠ” ì„±ê²©',ability:'ì¥ì• ë¬¼ 40% í•´ê²°',portrait_url:'',unlocked:'TRUE'},
        {char_id:'char_02',name:'ê¹€ìˆ˜ì—°',role:'companion',personality:'ì¡°ì–¸í˜• / ì‹ ì¤‘í•œ ì„±ê²©',ability:'ê²Œì„ì˜¤ë²„ ì‹œ 1íšŒ ìƒì¡´',portrait_url:'',unlock_condition:'1íšŒ ì—”ë”© ë˜ëŠ” 5íšŒ ê²Œì„ì˜¤ë²„',unlocked:'FALSE'},
        {char_id:'char_03',name:'ë°•ë¯¼ì² ',role:'companion',personality:'ê°•ì¸í•¨ / íˆ´íˆ´ê±°ë¦¬ëŠ” ì„±ê²©',ability:'ë¹„ìš°í˜¸ NPC 25% í•´ê²°',portrait_url:'',unlock_condition:'2íšŒ ì—”ë”© ë˜ëŠ” 10íšŒ ê²Œì„ì˜¤ë²„',unlocked:'FALSE'}
      ];
      gameData.items = [
        {item_id:'item_01',name:'ì†ë‚œë¡œ',icon:'ğŸ”¥',health_effect:'10',sanity_effect:'0'},
        {item_id:'item_02',name:'í†µì¡°ë¦¼',icon:'ğŸ¥«',health_effect:'20',sanity_effect:'0'},
        {item_id:'item_03',name:'ë¶•ëŒ€',icon:'ğŸ©¹',health_effect:'15',sanity_effect:'0'},
        {item_id:'item_04',name:'ì†ì „ë“±',icon:'ğŸ”¦',health_effect:'0',sanity_effect:'5'}
      ];
      gameData.config = { game_title:'RINGING', game_subtitle:'ë¹™í•˜ê¸° ìƒì¡´ ì–´ë“œë²¤ì²˜', initial_health:'100', initial_sanity:'100', start_scene:'scene_00' };
    }

    // ===== CACHE =====
    function getCachedData() {
      try { const cached = localStorage.getItem(CONFIG.CACHE_KEY); if (!cached) return null; const { data, timestamp } = JSON.parse(cached); if (Date.now() - timestamp > CONFIG.CACHE_DURATION) { localStorage.removeItem(CONFIG.CACHE_KEY); return null; } return data; } catch (e) { return null; }
    }
    function cacheData(data) { try { localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() })); } catch (e) { console.error('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e); } }

    // ===== INITIALIZATION =====
    function initGame() {
      currentSceneId = 'scene_00'; stats = { health: 100, sanity: 100 }; selectedCompanion = null; inventory = [];
      createSnow(); createWaveformBars(); renderCompanionList(); renderInventory();
      if (gameData.config.game_title) document.getElementById('gameTitle').textContent = gameData.config.game_title;
      if (gameData.config.game_subtitle) document.getElementById('gameSubtitle').textContent = gameData.config.game_subtitle;
      stats.health = parseInt(gameData.config.initial_health) || 100; stats.sanity = parseInt(gameData.config.initial_sanity) || 100;
      document.querySelectorAll('.companion-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('startBtn').disabled = true; document.getElementById('startBtn').textContent = 'ë™ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”';
      showScreen('titleScreen');
    }
    function updateLoadingStatus(text) { document.getElementById('loadingStatus').textContent = text; }

    // ===== UI HELPERS =====
    function createSnow() { const c = document.getElementById('snowContainer'); for (let i = 0; i < 50; i++) { const s = document.createElement('div'); s.className = 'snowflake'; s.textContent = 'â„'; s.style.left = Math.random() * 100 + '%'; s.style.animationDuration = (Math.random() * 3 + 4) + 's'; s.style.animationDelay = Math.random() * 5 + 's'; s.style.opacity = Math.random() * 0.7 + 0.3; s.style.fontSize = (Math.random() * 10 + 8) + 'px'; c.appendChild(s); } }
    function createWaveformBars() { const container = document.getElementById('waveform'); container.innerHTML = ''; for (let i = 0; i < 20; i++) { const bar = document.createElement('div'); bar.className = 'waveform-bar static'; bar.style.animationDelay = (i * 0.05) + 's'; container.appendChild(bar); } }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    // ===== COMPANION =====
    function renderCompanionList() {
      const list = document.getElementById('companionList'); list.innerHTML = '';
      const companions = gameData.characters.filter(c => c.role === 'companion');
      companions.forEach((comp, i) => {
        const isUnlocked = comp.unlocked === 'TRUE';
        const card = document.createElement('div'); card.className = `companion-card ${isUnlocked ? '' : 'locked'}`;
        card.onclick = () => isUnlocked && selectCompanion(i, comp);
        const avatarContent = comp.portrait_url ? `<img src="${comp.portrait_url}" alt="${comp.name}">` : ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¨â€ğŸ¦±'][i] || 'ğŸ‘¤';
        card.innerHTML = `${!isUnlocked ? '<div class="lock-badge">ğŸ”’</div>' : ''}<div class="companion-info"><div class="companion-avatar">${avatarContent}</div><div class="companion-details"><div class="companion-name">${comp.name}</div><div class="companion-trait">${comp.personality || ''}</div><div class="companion-ability">íŠ¹ì„±: ${comp.ability || ''}</div>${!isUnlocked && comp.unlock_condition ? `<div class="unlock-hint">í•´ê¸ˆ ì¡°ê±´: ${comp.unlock_condition}</div>` : ''}</div></div>`;
        list.appendChild(card);
      });
    }
    function selectCompanion(index, companion) { selectedCompanion = companion; document.querySelectorAll('.companion-card').forEach((c, i) => c.classList.toggle('selected', i === index)); document.getElementById('startBtn').disabled = false; document.getElementById('startBtn').textContent = `${companion.name}ì™€(ê³¼) ì¶œë°œ`; }

    // ===== GAME =====
    function startGame() {
      if (!selectedCompanion) return;
      currentSceneId = gameData.config.start_scene || 'scene_00';
      stats = { health: parseInt(gameData.config.initial_health) || 100, sanity: parseInt(gameData.config.initial_sanity) || 100 };
      inventory = gameData.items.slice(0, 4).map(item => ({...item}));
      gameStartTime = Date.now();
      showScreen('gameScreen');
      sendAnalytics('game_start', { companion: selectedCompanion.name });
      renderScene();
    }

    function renderScene() {
      const scene = gameData.scenes.find(s => s.scene_id === currentSceneId);
      if (!scene) { showNotification('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì—”ë”©ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.'); return; }
      sendAnalytics('scene_enter', { location: scene.location, has_sound: scene.has_sound === 'TRUE', has_mismatch: scene.has_mismatch === 'TRUE' });
      const bgEl = document.getElementById('sceneBg');
      if (scene.background_type === 'image' && scene.background_url) { bgEl.style.background = 'none'; bgEl.style.backgroundImage = `url(${convertDriveUrl(scene.background_url)})`; bgEl.style.backgroundSize = 'cover'; bgEl.style.backgroundPosition = 'center'; }
      else { bgEl.style.backgroundImage = 'none'; bgEl.style.background = getGradientForScene(currentSceneId); }
      document.getElementById('locationText').textContent = scene.location || '';
      document.getElementById('sceneIcon').textContent = scene.icon || '';
      const mainText = (scene.main_text || '').replace(/\\n/g, '\n');
      document.getElementById('mainText').textContent = mainText;
      const speakerEl = document.getElementById('speaker');
      if (scene.speaker && scene.speaker !== 'ë‚˜ë ˆì´ì…˜') { speakerEl.textContent = scene.speaker === 'ë™ë£Œ' ? selectedCompanion.name : scene.speaker; speakerEl.style.display = 'block'; } else { speakerEl.style.display = 'none'; }
      const soundBox = document.getElementById('soundBox'); const soundArea = document.getElementById('soundArea');
      const hasSound = scene.has_sound === 'TRUE';
      if (hasSound) { soundBox.classList.remove('no-sound'); soundArea.style.pointerEvents = 'auto'; document.getElementById('soundText').textContent = scene.sound_hint || 'ë¬´ì–¸ê°€ ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤...'; document.getElementById('soundDetail').textContent = scene.sound_detail || ''; document.getElementById('soundHint').style.display = scene.has_mismatch === 'TRUE' ? 'block' : 'none'; }
      else { soundBox.classList.add('no-sound'); soundArea.style.pointerEvents = 'none'; document.getElementById('soundText').textContent = '(ì¡°ìš©í•˜ë‹¤)'; document.getElementById('soundDetail').textContent = ''; document.getElementById('soundHint').style.display = 'none'; }
      const vignette = document.getElementById('vignette');
      if (scene.has_mismatch === 'TRUE') { vignette.classList.add('active'); soundBox.classList.add('mismatch'); } else { vignette.classList.remove('active'); soundBox.classList.remove('mismatch'); }
      const choices = gameData.choices.filter(c => c.scene_id === currentSceneId).sort((a, b) => parseInt(a.order) - parseInt(b.order));
      document.getElementById('choiceButtons').innerHTML = choices.map(c => `<button class="choice-btn" onclick="makeChoice('${c.choice_id}')">${c.text}</button>`).join('');
      updateStats();
    }

    function getGradientForScene(sceneId) {
      const gradients = { 'scene_00': 'linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)', 'scene_01': 'linear-gradient(180deg, #0d1b2a 0%, #1b263b 50%, #415a77 100%)', 'scene_02': 'linear-gradient(180deg, #1a1a2e 0%, #2d132c 50%, #4a1942 100%)', 'scene_03': 'linear-gradient(180deg, #0a0a1a 0%, #1a2744 50%, #2d3a4f 100%)', 'scene_04': 'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)', 'scene_05': 'linear-gradient(180deg, #0f1729 0%, #1a2744 50%, #2d4a6f 100%)', 'scene_06': 'linear-gradient(180deg, #1a1a2e 0%, #2d132c 50%, #801336 100%)', 'scene_07': 'linear-gradient(180deg, #0a0a1a 0%, #1a2744 100%)', 'scene_08': 'linear-gradient(180deg, #0f1729 0%, #1a3a5c 50%, #2d5a8f 100%)', 'scene_09': 'linear-gradient(180deg, #0a0a1a 0%, #1a2744 100%)' };
      return gradients[sceneId] || 'linear-gradient(180deg, #0a0a1a 0%, #1a2744 100%)';
    }
    function convertDriveUrl(url) { if (!url) return ''; const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`; return url; }

    function makeChoice(choiceId) {
      const choice = gameData.choices.find(c => c.choice_id === choiceId);
      if (!choice) return;
      const healthChange = parseInt(choice.health_change) || 0;
      const sanityChange = parseInt(choice.sanity_change) || 0;
      sendAnalytics('choice', { choice_id: choiceId, choice_text: choice.text, health_change: healthChange, sanity_change: sanityChange });
      if (healthChange !== 0) { stats.health = Math.max(0, Math.min(100, stats.health + healthChange)); showNotification(healthChange > 0 ? `â¤ï¸ ìƒëª…ë ¥ +${healthChange}` : `ğŸ’” ìƒëª…ë ¥ ${healthChange}`); }
      if (sanityChange !== 0) { setTimeout(() => { stats.sanity = Math.max(0, Math.min(100, stats.sanity + sanityChange)); showNotification(sanityChange > 0 ? `ğŸ§  ì •ì‹ ë ¥ +${sanityChange}` : `ğŸ˜° ì •ì‹ ë ¥ ${sanityChange}`); }, healthChange !== 0 ? 1500 : 0); }
      updateStats();
      if (stats.health <= 0) { setTimeout(() => gameOver('ìƒëª…ë ¥ì´ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤...'), 500); return; }
      if (stats.sanity <= 0) { setTimeout(() => gameOver('ì •ì‹ ë ¥ì´ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤...'), 500); return; }
      if (choice.next_scene_id.startsWith('ending')) { sendAnalytics('ending', { ending_choice: choiceId, ending_type: choice.next_scene_id }); setTimeout(() => showNotification('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì—”ë”©ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.'), 500); return; }
      setTimeout(() => { currentSceneId = choice.next_scene_id; isListening = false; document.getElementById('listenOverlay').classList.remove('active'); document.getElementById('soundBox').classList.remove('listening'); stopSound(); renderScene(); }, 300);
    }
    function updateStats() { document.getElementById('healthBar').style.width = stats.health + '%'; document.getElementById('healthVal').textContent = stats.health; document.getElementById('sanityBar').style.width = stats.sanity + '%'; document.getElementById('sanityVal').textContent = stats.sanity; }

    // ===== LISTENING =====
    function startListen() {
      const scene = gameData.scenes.find(s => s.scene_id === currentSceneId);
      if (!scene || scene.has_sound !== 'TRUE') return;
      listenStartTime = Date.now();
      listenTimer = setTimeout(() => { isListening = true; document.getElementById('soundBox').classList.add('listening'); document.getElementById('listenOverlay').classList.add('active'); document.getElementById('soundHint').textContent = 'ì§‘ì¤‘ ì¤‘...'; document.querySelectorAll('.waveform-bar').forEach(bar => bar.classList.remove('static')); if (scene.sound_url) playSound(convertDriveUrl(scene.sound_url)); }, 400);
    }
    function endListen() {
      if (listenTimer) clearTimeout(listenTimer);
      if (listenStartTime && isListening) { const duration = Date.now() - listenStartTime; sendAnalytics('listen', { duration_ms: duration, completed: duration >= 400 }); }
      listenStartTime = null;
      const scene = gameData.scenes.find(s => s.scene_id === currentSceneId);
      isListening = false; document.getElementById('soundBox').classList.remove('listening'); document.getElementById('listenOverlay').classList.remove('active');
      if (scene && scene.has_mismatch === 'TRUE') document.getElementById('soundHint').textContent = 'ê¾¹ ëˆŒëŸ¬ì„œ ì§‘ì¤‘';
      document.querySelectorAll('.waveform-bar').forEach(bar => bar.classList.add('static')); stopSound();
    }
    function playSound(url) { if (!url) return; try { const audio = document.getElementById('soundPlayer'); audio.src = url; audio.volume = 0.5; audio.play().catch(e => console.log('Audio play failed:', e)); } catch (e) { console.log('Sound playback error:', e); } }
    function stopSound() { const audio = document.getElementById('soundPlayer'); if (audio) { audio.pause(); audio.currentTime = 0; } }

    // ===== INVENTORY =====
    function renderInventory() { const grid = document.getElementById('inventoryGrid'); grid.innerHTML = ''; for (let i = 0; i < 8; i++) { const item = inventory[i]; const slot = document.createElement('div'); slot.className = `inv-item ${item ? '' : 'empty'}`; if (item) { slot.innerHTML = `<span class="inv-icon">${item.icon}</span><span class="inv-name">${item.name}</span>`; slot.onclick = () => useItem(i); } grid.appendChild(slot); } }
    function useItem(index) {
      const item = inventory[index]; if (!item) return;
      const healthEffect = parseInt(item.health_effect) || 0; const sanityEffect = parseInt(item.sanity_effect) || 0;
      sendAnalytics('item_use', { item_name: item.name, health_effect: healthEffect, sanity_effect: sanityEffect });
      if (healthEffect !== 0) { stats.health = Math.min(100, stats.health + healthEffect); showNotification(`${item.icon} ${item.name} ì‚¬ìš©! ìƒëª…ë ¥ +${healthEffect}`); }
      if (sanityEffect !== 0) { stats.sanity = Math.min(100, stats.sanity + sanityEffect); showNotification(`${item.icon} ${item.name} ì‚¬ìš©! ì •ì‹ ë ¥ +${sanityEffect}`); }
      updateStats(); inventory.splice(index, 1); renderInventory(); toggleBag();
    }

    // ===== MODALS =====
    function toggleHelp() { document.getElementById('helpModal').classList.toggle('active'); }
    function toggleBag() { document.getElementById('bagModal').classList.toggle('active'); }

    // ===== NOTIFICATIONS =====
    function showNotification(msg) { const el = document.getElementById('notification'); el.textContent = msg; el.classList.add('active'); setTimeout(() => el.classList.remove('active'), 2500); }
    function gameOver(reason) {
      const gameOverReason = stats.health <= 0 ? 'health' : 'sanity';
      sendAnalytics('game_over', { reason: gameOverReason, final_scene: currentSceneId });
      document.getElementById('gameoverReason').textContent = reason; document.getElementById('gameoverOverlay').classList.add('active');
    }
    function restartGame() { document.getElementById('gameoverOverlay').classList.remove('active'); showScreen('titleScreen'); selectedCompanion = null; document.querySelectorAll('.companion-card').forEach(c => c.classList.remove('selected')); document.getElementById('startBtn').disabled = true; document.getElementById('startBtn').textContent = 'ë™ë£Œë¥¼ ì„ íƒí•˜ì„¸ìš”'; }

    // ===== SESSION END (page leave) =====
    window.addEventListener('beforeunload', function() {
      if (gameStartTime) {
        sendAnalytics('session_end', {
          end_reason: 'leave',
          final_scene: currentSceneId
        });
      }
    });

    // ===== START =====
    loadGameData();
  </script>
</body>
</html>